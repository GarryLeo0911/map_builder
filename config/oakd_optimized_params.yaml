# OAK-D Optimized Map Builder Parameters
# Based on rtabmap best practices and OAK-D characteristics

point_cloud_processor:
  ros__parameters:
    # Basic filtering parameters optimized for OAK-D stereo
    voxel_size: 0.015            # Finer voxel for OAK-D's high-quality depth
    max_range: 5.0               # Conservative range for indoor mapping
    min_range: 0.4               # Avoid stereo noise at close range
    statistical_outlier_nb_neighbors: 15
    statistical_outlier_std_ratio: 0.8  # Strict outlier removal
    buffer_size: 20              # Small buffer for real-time
    
    # OAK-D specific stereo depth filtering
    enable_depth_filtering: true
    depth_confidence_threshold: 0.8  # High confidence threshold
    enable_stereo_consistency_check: true
    stereo_baseline: 0.075       # OAK-D baseline: 7.5cm
    
    # Enhanced filtering (optimized for stereo)
    enable_bilateral_filter: false  # Not needed for stereo
    enable_ground_removal: true
    ground_threshold: 0.03       # Sensitive ground detection
    enable_radius_outlier_removal: true
    radius_search: 0.04          # Small radius for dense clouds
    min_neighbors_radius: 2      # Less strict for real-time
    
    # Clustering for object separation
    enable_clustering: true
    cluster_tolerance: 0.04
    min_cluster_size: 8
    max_cluster_size: 8000
    
    # Registration optimized for accuracy
    enable_registration: true
    registration_max_correspondence_distance: 0.04
    registration_max_iterations: 25
    registration_transformation_epsilon: 1e-6
    registration_euclidean_fitness_epsilon: 1e-6
    
    # Adaptive voxel sizing
    adaptive_voxel_size: true
    min_voxel_size: 0.008        # Very fine for detailed areas
    max_voxel_size: 0.025        # Reasonable maximum
    target_points_per_cloud: 2500  # Optimized for OAK-D rate
    
    # Motion filtering for dynamic environments
    enable_motion_filtering: true
    max_point_motion: 0.3
    
    # Normal estimation for surfaces
    enable_normal_estimation: true
    normal_search_radius: 0.025
    normal_k_search: 8

enhanced_visual_odometry:
  ros__parameters:
    # Feature detection optimized for OAK-D RGB quality
    feature_detector_threshold: 12.0  # Lower for indoor scenes
    max_features: 2000               # More features for accuracy
    match_ratio_threshold: 0.8       # Stricter Lowe's ratio
    min_matches: 25                  # Conservative minimum
    ransac_threshold: 1.5            # Tight RANSAC threshold
    max_translation_per_frame: 0.3   # Conservative motion limits
    max_rotation_per_frame: 0.2
    
    # IMU fusion (OAK-D has integrated IMU)
    enable_imu_fusion: true
    imu_weight: 0.15                 # Light IMU influence
    gravity_magnitude: 9.81
    
    # Point cloud odometry fallback
    voxel_size: 0.012               # Very fine for accuracy
    icp_max_correspondence_distance: 0.025
    icp_max_iterations: 25
    icp_transformation_epsilon: 1e-6
    
    # Frame management
    max_frame_buffer_size: 4        # Minimal buffer

surface_reconstructor:
  ros__parameters:
    # Optimized for real-time reconstruction
    mesh_resolution: 0.025       # Balance between detail and speed
    clustering_tolerance: 0.04
    clustering_min_cluster_size: 30
    clustering_max_cluster_size: 15000
    convex_hull_alpha: 0.04
    
    # Use greedy projection for speed
    reconstruction_method: "greedy_projection"
    
    # Greedy projection parameters (optimized)
    gp3_search_radius: 0.08
    gp3_mu: 1.8
    gp3_max_nearest_neighbors: 40
    gp3_max_surface_angle: 0.785
    gp3_min_angle: 0.175
    gp3_max_angle: 2.094
    
    # Normal estimation for reconstruction
    normal_search_radius: 0.04
    normal_k_search: 12
    
    # Region growing
    enable_region_growing: true
    region_growing_min_cluster_size: 20
    region_growing_max_cluster_size: 300000
    region_growing_neighbors: 15
    region_growing_smoothness_threshold: 2.0
    region_growing_curvature_threshold: 0.6

map_builder_node:
  ros__parameters:
    # High-resolution mapping for OAK-D quality
    map_resolution: 0.02         # Fine resolution
    map_width: 1200             # Large coverage
    map_height: 1200
    map_origin_x: -12.0
    map_origin_y: -12.0
    robot_radius: 0.18          # Typical mobile robot
    min_obstacle_height: 0.02   # Detect small obstacles
    max_obstacle_height: 2.2
    
    # Enhanced loop closure
    enable_loop_closure: true
    loop_closure_distance_threshold: 1.2  # Tight distance
    loop_closure_feature_threshold: 0.85  # High similarity
    min_loop_closure_interval: 20         # Frequent checking
    keyframe_buffer_size: 40             # Moderate buffer
    
    # Memory management
    enable_memory_management: true
    max_map_points: 600000      # Moderate for performance
    memory_cleanup_interval: 15.0
    
    # Conservative probabilistic mapping
    occupancy_hit_probability: 0.8      # High confidence hits
    occupancy_miss_probability: 0.3     # Conservative misses
    occupancy_min_probability: 0.18     # Higher uncertainty floor
    occupancy_max_probability: 0.92     # Conservative certainty ceiling